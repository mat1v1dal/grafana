ARG VERSION=v3.2.1

# Stage 1: get envsubst from Alpine
FROM alpine:3.19 AS tools
RUN apk add --no-cache gettext

# Stage 2: Prometheus with envsubst binary copied in
FROM prom/prometheus:${VERSION}
COPY --from=tools /usr/bin/envsubst /usr/local/bin/envsubst
COPY prom.yml /etc/prometheus/prom.yml.template

ENTRYPOINT ["sh", "-c", "envsubst < /etc/prometheus/prom.yml.template > /etc/prometheus/prom.yml && /bin/prometheus --config.file=/etc/prometheus/prom.yml --storage.tsdb.path=/prometheus"]
